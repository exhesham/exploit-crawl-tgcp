var request = require('request')
var https = require('https');
var fs = require('fs');


const cheerio = require('cheerio');


var url = 'https://www.thegreatcoursesplus.com/show/the_celtic_world' // input your url here
var cookies = ''
function to_friendly_filename(s){
    return s.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}

/***
 * after reveiling the iframe, send the link here so it will download the file
 * @param url
 * @param path
 */
function download_lesson_iframe(url, path){
    var file = fs.createWriteStream(path);
    var req = https.get(url, function(response) {
        response.pipe(file);
    });
}
async function reveal_video_link_from_iframe(url, cookies){
    var body = await get_html_from_url(url,cookies);
    body = body.replace(/\r?\n|\r/g, " ")
    var pattern = /sources:\s+\[.*\]/
    if(!pattern.test(body)){
        throw 'cannot find sources!!!'
    }
    var sources = pattern.exec(body);
    if(sources.length  == 1){
        var data = '{' + sources[0] + '}';
        data = data.replace(/\t/g, "")
        data = data.replace(" ", "")
        data.replace(/(['"])?([a-zA-Z0-9]+)(['"])?:/g, '"$2":');
        var resolutions = JSON.parse(data);
        return resolutions;
    }else{
        throw 'sources length is not 1'
    }


}
function parse_lecture_from_html_body(body){
    var lecture = {};
    var lessons = [];
    const $ = cheerio.load(body);
    lecture.title = $('.course-info-container h1')[0].children[0].data;
    $('.list-tray-item').each(function (i, elem) {
        var lesson_index = $(this).find($(".list-tray-item-index"))[0].children[0].data;
        var lesson_url = $(this)[0].attribs['href'];
        var lesson_id = $(this)[0].attribs['data-film-id'];
        var lesson_title = $(this)[0].attribs['data-title'];
        lessons.push({
            'lesson-index': lesson_index,
            'lesson-title': lesson_title,
            'lesson-url': lesson_url,
            'lesson-id': lesson_id
        });
    });
    lecture.lessons = lessons;
    return lecture;
}

function doRequest(url, cookies) {
    // use a timeout value of 10 seconds
    var timeoutInMilliseconds = 10*1000

    var opts = {
        url: url,
        headers: {Cookie: cookies},
        timeout: timeoutInMilliseconds
    }
    return new Promise(function (resolve, reject) {
        request(opts, function (error, res, body) {
            if (!error && res.statusCode == 200) {
                resolve(body);
            } else {
                reject(error);
            }
        });
    });
}

/***
 * get a url and cookies then return the html as string - throw an error if something went wrong
 * @param url
 * @param cookies
 */
async function get_html_from_url(url, cookies){

    let body = await doRequest(url,cookies);
    return body;
}

// get_html_from_url(url, cookies).then(body =>{
//     console.log(parse_lecture_from_html_body(body));
// });
reveal_video_link_from_iframe('https://www.thegreatcoursesplus.com/embed/player?filmId=00000161-e7d8-dcbf-a561-f7de7d2c0000', cookies).then(url=>console.log(url));
//download_lesson_iframe('https://vtgcmp4-viewlift.akamaized.net/Renditions/2018/03/1520013053241_3733_01/feb56f24-56a1-4a23-ba0a-f1df0ad37347.mp4?7544bdcc50dae6fd8d8ebeb3ba54706c7eb1db7bd808eb469b2096b72d88a24859ebd5b074e68f81d4906febba6dd9a40b&hdnts=st=1525436261~exp=1525522661~acl=/*~hmac=b1cbcbc4fd7e747d19aa0f23acd6d6cc7542ed3b172e559f364f2c9d09b3e42a', cookies, './')